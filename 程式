#include <WiFi.h>
#include <WebServer.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SH110X.h>
#include "time.h"

// OLED è¨­å®š
#define i2c_Address 0x3c
Adafruit_SH1106G display = Adafruit_SH1106G(128, 64, &Wire, -1);

// WiFi è³‡è¨Š
const char* ssid = "ttimcc";
const char* password = "12345678";

// --- å°ç£æ”¿åºœ API è¨­å®š ---
String cwa_key = "CWA-D729C38A-6520-49F0-A196-0CB7B296A845"; 
String moenv_key = "290d8402-2359-4eec-a7ed-4e34657e2c80";
String my_city = "è‡ºå—å¸‚"; 
String my_station = "å®‰å—"; 

// æ™‚é–“ä¼ºæœå™¨è¨­å®š
const char* ntpServer = "pool.ntp.org";
const long  gmtOffset_sec = 28800; 
const int   daylightOffset_sec = 0;

WebServer server(80);
unsigned long lastUpdateTime = 0;

// æ•¸æ“šå®šç¾© (å¢åŠ åˆ° 6 å€‹é¸é …)
int pos[3] = {4, 5, 0}; // é è¨­ï¼šç¾åœ¨æ™‚é–“, ä»Šå¤©æ—¥æœŸ, æº«åº¦
String dataNames[] = {"æº«åº¦", "é¢¨é€Ÿ", "ç©ºæ°£å“è³ª", "æ¿•åº¦", "ç¾åœ¨æ™‚é–“", "ä»Šå¤©æ—¥æœŸ"};
String dataValues[] = {"-- C", "-- m/s", "--", "-- %", "00:00:00", "2025/01/01"};

// 1. æŠ“å–æ°£è±¡ç½²æ•¸æ“š
void fetchCWAData() {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    String url = "https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?Authorization=" + cwa_key + "&format=JSON&StationName=" + my_station;
    http.begin(url);
    if (http.GET() == 200) {
      DynamicJsonDocument doc(4096);
      deserializeJson(doc, http.getString());
      JsonObject weatherData = doc["records"]["Station"][0]["WeatherElement"];
      dataValues[0] = weatherData["AirTemperature"].as<String>() + " C";
      dataValues[1] = weatherData["WindSpeed"].as<String>() + " m/s";
      dataValues[3] = weatherData["RelativeHumidity"].as<String>() + " %";
    }
    http.end();
  }
}

// 2. æŠ“å–ç’°å¢ƒéƒ¨ AQI (ä¿®æ­£äº‚ç¢¼ï¼šè½‰æ›ç‚ºè‹±æ–‡)
void fetchAQIData() {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    // ä½¿ç”¨ aqx_p_48 æ˜¯æœ€ç©©å®šçš„å³æ™‚ AQI ä¾†æº
    String url = "http://data.moenv.gov.tw/api/v2/aqx_p_48?language=zh&api_key=" + moenv_key + "&limit=100";
    http.begin(url);
    if (http.GET() == 200) {
      DynamicJsonDocument doc(16384);
      deserializeJson(doc, http.getString());
      JsonArray records = doc["records"];
      for (JsonObject record : records) {
        if (record["sitename"] == my_station) {
          String aqi = record["aqi"].as<String>();
          String status = record["status"].as<String>();
          
          // --- è§£æ±ºäº‚ç¢¼ï¼šå°æ‡‰è¡¨ ---
          String engStatus = "OK";
          if (status == "è‰¯å¥½") engStatus = "Good";
          else if (status == "æ™®é€š") engStatus = "Fair";
          else if (status == "å°æ•æ„Ÿæ—ç¾¤ä¸å¥åº·") engStatus = "M.Bad";
          else if (status == "å°æ‰€æœ‰æ—ç¾¤ä¸å¥åº·") engStatus = "Bad";
          else if (status == "éå¸¸ä¸å¥åº·") engStatus = "V.Bad";
          else if (status == "å±å®³") engStatus = "Hazard";

          dataValues[2] = aqi + " " + engStatus;
          break;
        }
      }
    }
    http.end();
  }
}

void updateLocalTime() {
  struct tm timeinfo;
  if(getLocalTime(&timeinfo)){
    char bufT[10];
    char bufD[15];
    strftime(bufT, sizeof(bufT), "%H:%M:%S", &timeinfo);
    strftime(bufD, sizeof(bufD), "%Y/%m/%d", &timeinfo);
    dataValues[4] = String(bufT);
    dataValues[5] = String(bufD);
  }
}

// ç¶²é  HTML
void handleRoot() {
  updateLocalTime();
  String html = "<html><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1.0'><style>";
  html += "body{font-family:sans-serif; background:#f0f0f0; display:flex; flex-direction:column; align-items:center;}";
  html += ".card{background:white; padding:20px; border-radius:10px; width:320px; box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-top:20px;}";
  html += "select{width:100%; padding:10px; margin:10px 0; border-radius:5px;}";
  html += "</style><script>";
  html += "function validate(){ let s=[document.getElementById('p0'),document.getElementById('p1'),document.getElementById('p2')]; s.forEach((sel,i)=>{for(let opt of sel.options){opt.disabled=false; s.forEach((other,j)=>{if(i!==j && other.value===opt.value)opt.disabled=true;});}}); }";
  html += "</script></head><body onload='validate()'>";
  html += "<div class='card'><h2>æ°£è±¡æ§åˆ¶å°</h2>";
  html += "<p style='color:blue;'>ğŸ“ æ¸¬ç«™: " + my_station + "</p>";
  html += "<form action='/update'>";
  for(int i=0; i<3; i++){
    html += "ä½ç½® "+String(i+1)+": <select name='p"+String(i)+"' id='p"+String(i)+"' onchange='validate()'>";
    for(int j=0; j<6; j++) html += "<option value='"+String(j)+"'"+(pos[i]==j?" selected":"")+">"+dataNames[j]+"</option>";
    html += "</select><br>";
  }
  html += "<input type='submit' value='å¥—ç”¨æ’ç‰ˆ' style='width:100%; padding:12px; background:#007bff; color:white; border:none; border-radius:5px;'></form></div>";
  html += "</body></html>";
  server.send(200, "text/html", html);
}

void handleUpdate() {
  for(int i=0; i<3; i++) { if(server.hasArg("p"+String(i))) pos[i] = server.arg("p"+String(i)).toInt(); }
  server.sendHeader("Location", "/");
  server.send(303);
}

void setup() {
  Serial.begin(115200);
  display.begin(i2c_Address, true);
  display.clearDisplay();
  display.setTextColor(SH110X_WHITE);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) { delay(500); }
  
  configTime(gmtOffset_sec, daylightOffset_sec, ntpServer);
  
  fetchCWAData(); 
  fetchAQIData();
  
  server.on("/", handleRoot);
  server.on("/update", handleUpdate);
  server.begin();
}

void loop() {
  server.handleClient();
  updateLocalTime();

  if (millis() - lastUpdateTime > 600000) {
    fetchCWAData();
    fetchAQIData();
    lastUpdateTime = millis();
  }

  display.clearDisplay();
  // OLED é¡¯ç¤ºé‚è¼¯
  display.setTextSize(2); 
  display.setCursor(0, 2); 
  display.print(dataValues[pos[0]]); // ç¬¬ä¸€è¡Œå¤§å­—

  display.setTextSize(1); 
  display.setCursor(0, 32); 
  display.print(dataValues[pos[1]]); // ç¬¬äºŒè¡Œ

  display.setCursor(0, 50); 
  display.print(dataValues[pos[2]]); // ç¬¬ä¸‰è¡Œ
  
  display.display();
  delay(500);
}
